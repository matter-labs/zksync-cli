version: '3.2'

services:
  portal-dockerized-node:
    environment:
      - NODE_TYPE=memory
    build:
      dockerfile_inline: |
        # ---- Build Stage ----
        FROM node:18-alpine AS build
        WORKDIR /app
        RUN apk add --no-cache python3 make g++ git
        RUN git clone https://github.com/matter-labs/dapp-portal.git .
        RUN npm ci
        RUN npm run generate:node:memory

        # ---- Serve Stage ----
        FROM node:18-alpine AS serve
        WORKDIR /app
        RUN npm install -g serve
        COPY --from=build /app/.output/public ./.output/public
        EXPOSE 3000
        CMD ["serve", "-s", ".output/public", "-p", "3000"]
    ports:
      - "3000:3000"
